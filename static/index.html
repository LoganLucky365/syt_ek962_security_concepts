<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Service</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        /* Login Form */
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            padding: 12px 15px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-google {
            background: #fff;
            border: 2px solid #e1e1e1;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-google:hover {
            background: #f5f5f5;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #aaa;
            font-size: 14px;
        }

        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e1e1e1;
        }

        .divider span {
            padding: 0 15px;
        }

        /* User Info Panel */
        .user-panel {
            text-align: center;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 32px;
            color: white;
        }

        .user-name {
            font-size: 22px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .user-email {
            color: #777;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .user-role {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .role-admin {
            background: #fff3cd;
            color: #856404;
        }

        .role-user {
            background: #d4edda;
            color: #155724;
        }

        .user-actions {
            margin-top: 25px;
        }

        /* Messages */
        .message {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .message-error {
            background: #fee;
            color: #c00;
            border: 1px solid #fcc;
        }

        .message-success {
            background: #efe;
            color: #060;
            border: 1px solid #cfc;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Loading */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Provider Tabs */
        .provider-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .provider-tab {
            flex: 1;
            padding: 10px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .provider-tab:hover {
            border-color: #667eea;
        }

        .provider-tab.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .google-icon {
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Auth Service</h1>
            <p id="header-subtitle">Bitte einloggen</p>
        </div>

        <div class="content">
            <!-- Login Section -->
            <div id="login-section">
                <div id="message" class="message hidden"></div>

                <!-- Provider Tabs -->
                <div class="provider-tabs">
                    <div class="provider-tab active" data-provider="local">Local</div>
                    <div class="provider-tab" data-provider="ldap">LDAP/AD</div>
                    <div class="provider-tab" data-provider="google">Google</div>
                </div>

                <!-- Local Login Form -->
                <form id="local-form" class="login-form">
                    <div class="form-group">
                        <label for="email">E-Mail</label>
                        <input type="email" id="email" placeholder="name@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Passwort</label>
                        <input type="password" id="password" placeholder="••••••••••••" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Einloggen</button>
                </form>

                <!-- LDAP Login Form -->
                <form id="ldap-form" class="login-form hidden">
                    <div class="form-group">
                        <label for="ldap-username">Benutzername</label>
                        <input type="text" id="ldap-username" placeholder="username" required>
                    </div>
                    <div class="form-group">
                        <label for="ldap-password">Passwort</label>
                        <input type="password" id="ldap-password" placeholder="••••••••••••" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Mit LDAP einloggen</button>
                </form>

                <!-- Google Login -->
                <div id="google-form" class="login-form hidden">
                    <button type="button" id="google-login-btn" class="btn btn-google">
                        <svg class="google-icon" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Mit Google einloggen
                    </button>
                </div>
            </div>

            <!-- User Panel (logged in) -->
            <div id="user-section" class="user-panel hidden">
                <div class="user-avatar" id="user-avatar">?</div>
                <div class="user-name" id="user-name">-</div>
                <div class="user-email" id="user-email">-</div>
                <div class="user-role" id="user-role">-</div>
                <div class="user-actions">
                    <button id="logout-btn" class="btn btn-danger" style="width: 100%;">Ausloggen</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';  // Same origin

        // State
        let currentToken = localStorage.getItem('auth_token');
        let currentUser = JSON.parse(localStorage.getItem('auth_user') || 'null');

        // Elements
        const loginSection = document.getElementById('login-section');
        const userSection = document.getElementById('user-section');
        const messageEl = document.getElementById('message');
        const headerSubtitle = document.getElementById('header-subtitle');

        const localForm = document.getElementById('local-form');
        const ldapForm = document.getElementById('ldap-form');
        const googleForm = document.getElementById('google-form');
        const providerTabs = document.querySelectorAll('.provider-tab');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (currentToken && currentUser) {
                verifyAndShowUser();
            } else {
                showLogin();
            }

            // Provider tabs
            providerTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const provider = tab.dataset.provider;
                    switchProvider(provider);
                });
            });

            // Forms
            localForm.addEventListener('submit', handleLocalLogin);
            ldapForm.addEventListener('submit', handleLdapLogin);
            document.getElementById('google-login-btn').addEventListener('click', handleGoogleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        });

        function switchProvider(provider) {
            providerTabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-provider="${provider}"]`).classList.add('active');

            localForm.classList.add('hidden');
            ldapForm.classList.add('hidden');
            googleForm.classList.add('hidden');

            if (provider === 'local') localForm.classList.remove('hidden');
            if (provider === 'ldap') ldapForm.classList.remove('hidden');
            if (provider === 'google') googleForm.classList.remove('hidden');

            hideMessage();
        }

        function showMessage(text, isError = true) {
            messageEl.textContent = text;
            messageEl.className = `message ${isError ? 'message-error' : 'message-success'}`;
            messageEl.classList.remove('hidden');
        }

        function hideMessage() {
            messageEl.classList.add('hidden');
        }

        function showLogin() {
            loginSection.classList.remove('hidden');
            userSection.classList.add('hidden');
            headerSubtitle.textContent = 'Bitte einloggen';
        }

        function showUser() {
            loginSection.classList.add('hidden');
            userSection.classList.remove('hidden');
            headerSubtitle.textContent = 'Willkommen!';

            if (currentUser) {
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('user-email').textContent = currentUser.email;
                document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();

                const roleEl = document.getElementById('user-role');
                roleEl.textContent = currentUser.role;
                roleEl.className = `user-role role-${currentUser.role}`;
            }
        }

        async function verifyAndShowUser() {
            try {
                const res = await fetch(`${API_BASE}/auth/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: currentToken })
                });

                const data = await res.json();

                if (data.valid) {
                    showUser();
                } else {
                    handleLogout();
                }
            } catch (e) {
                console.error('Verify error:', e);
                handleLogout();
            }
        }

        async function handleLocalLogin(e) {
            e.preventDefault();
            hideMessage();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                localForm.classList.add('loading');

                const res = await fetch(`${API_BASE}/auth/signin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();

                if (res.ok) {
                    saveAuth(data.token, data.user);
                    showMessage('Erfolgreich eingeloggt!', false);
                    setTimeout(showUser, 500);
                } else {
                    showMessage(data.error || 'Login fehlgeschlagen');
                }
            } catch (e) {
                showMessage('Verbindungsfehler');
            } finally {
                localForm.classList.remove('loading');
            }
        }

        async function handleLdapLogin(e) {
            e.preventDefault();
            hideMessage();

            const username = document.getElementById('ldap-username').value;
            const password = document.getElementById('ldap-password').value;

            try {
                ldapForm.classList.add('loading');

                const res = await fetch(`${API_BASE}/auth/ldap/signin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();

                if (res.ok) {
                    saveAuth(data.token, data.user);
                    showMessage('Erfolgreich eingeloggt!', false);
                    setTimeout(showUser, 500);
                } else {
                    showMessage(data.error || 'LDAP Login fehlgeschlagen');
                }
            } catch (e) {
                showMessage('Verbindungsfehler');
            } finally {
                ldapForm.classList.remove('loading');
            }
        }

        async function handleGoogleLogin() {
            hideMessage();

            try {
                const res = await fetch(`${API_BASE}/auth/google/login`);
                const data = await res.json();

                if (res.ok && data.authorization_url) {
                    // Store state for CSRF verification
                    localStorage.setItem('oauth_state', data.state);
                    // Redirect to Google
                    window.location.href = data.authorization_url;
                } else {
                    showMessage(data.error || 'Google OAuth nicht konfiguriert');
                }
            } catch (e) {
                showMessage('Verbindungsfehler');
            }
        }

        function handleLogout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('auth_user');
            currentToken = null;
            currentUser = null;
            showLogin();
        }

        function saveAuth(token, user) {
            currentToken = token;
            currentUser = user;
            localStorage.setItem('auth_token', token);
            localStorage.setItem('auth_user', JSON.stringify(user));
        }

        // Google OAuth callback is handled server-side now
        // The server returns HTML that stores the token and redirects here
    </script>
</body>
</html>
